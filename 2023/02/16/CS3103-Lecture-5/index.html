<!DOCTYPE html><html lang="zh-HK"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.8.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.8.0" type="image/png" sizes="32x32"><meta name="description" content="Synchronization">
<meta property="og:type" content="article">
<meta property="og:title" content="CS3103-Lecture-5">
<meta property="og:url" content="https://lemonkai.github.io/2023/02/16/CS3103-Lecture-5/index.html">
<meta property="og:site_name" content="KAI Blog">
<meta property="og:description" content="Synchronization">
<meta property="og:locale" content="zh_HK">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230216163710.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230216164001.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230216172127.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230223163014.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230223163810.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230223171657.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230223172726.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230223173215.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230223173845.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230223173914.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302152249.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302152346.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302152851.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302153314.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302153701.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302154111.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302155321.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302161653.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302161811.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302162036.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302162102.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302163650.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302164138.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302164204.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302164546.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302164727.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230302164819.png">
<meta property="article:published_time" content="2023-02-16T08:30:42.000Z">
<meta property="article:modified_time" content="2023-03-02T09:02:18.691Z">
<meta property="article:author" content="KAI">
<meta property="article:tag" content="CS3103">
<meta property="article:tag" content="Operating System">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/LemonKAI/image/main/20230216163710.png"><title>CS3103-Lecture-5 | KAI Blog</title><link ref="canonical" href="https://lemonkai.github.io/2023/02/16/CS3103-Lecture-5/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.0"><link rel="stylesheet" href="css/custom.css"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"複製","copySuccess":"複製成功","copyError":"複製失敗"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首頁</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">歸檔</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分類</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">標籤</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">CS3103-Lecture-5</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">發表於</span><span class="post-meta-item__value">2023-02-16</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新於</span><span class="post-meta-item__value">2023-03-02</span></span></div></header><div class="post-body">
        <h1 id="Synchronization"   >
          <a href="#Synchronization" class="heading-link"><i class="fas fa-link"></i></a><a href="#Synchronization" class="headerlink" title="Synchronization"></a>Synchronization</h1>
      <span id="more"></span>


        <h2 id="Backgrouond"   >
          <a href="#Backgrouond" class="heading-link"><i class="fas fa-link"></i></a><a href="#Backgrouond" class="headerlink" title="Backgrouond"></a>Backgrouond</h2>
      <ul>
<li><p>Concurrent access to shared data may result in data inconsistency – <strong>race condition</strong></p>
</li>
<li><p>Maintianing data consistency requires mechanisms to ensure the orderly execution of coorperating processes&#x2F;threads</p>
</li>
</ul>

        <h2 id="Race-Condition"   >
          <a href="#Race-Condition" class="heading-link"><i class="fas fa-link"></i></a><a href="#Race-Condition" class="headerlink" title="Race Condition"></a>Race Condition</h2>
      <ul>
<li>Example: two thrads access shared variable Y<ul>
<li>Thread 1 : Y &#x3D; Y + 1</li>
<li>Thread 2 : Y &#x3D; Y * 2<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230216163710.png"></li>
</ul>
</li>
</ul>

        <h2 id="Critical-Section"   >
          <a href="#Critical-Section" class="heading-link"><i class="fas fa-link"></i></a><a href="#Critical-Section" class="headerlink" title="Critical Section"></a>Critical Section</h2>
      <ul>
<li><p>Parts of the program where the shared resource is accessed need to be protected in ways that avoid the concurrent access</p>
</li>
<li><p>This protected section is the critical section or critical region<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230216164001.png"></p>
</li>
<li><p>A good solution of CS satisfies following conditions</p>
<ul>
<li><strong>Mutual Exclusion</strong>: If one process is executing in tis CS, then no other processes can be executing in CS</li>
<li><strong>Progress</strong>: If no process is executing in CS and some processes wish to enter CS, then the selection of the porcesses to enter the CS next should not be postponed forever</li>
<li><strong>Bounded Waitting</strong>: A bound must exist on the number of times that other processes are allowed to enter their CS after a process has made a request to enter its CS and before that request is granted</li>
<li><strong>Independence</strong>: The solution should not depend on the speed or the number of processors, as well as other factors that can affect the execution of the processes. The solution should be able to handle any number of processes, and any processing speed without being affected by external factors</li>
</ul>
</li>
</ul>

        <h2 id="Mutex-Lock"   >
          <a href="#Mutex-Lock" class="heading-link"><i class="fas fa-link"></i></a><a href="#Mutex-Lock" class="headerlink" title="Mutex Lock"></a>Mutex Lock</h2>
      <ul>
<li>A mutex lock (called mutex for short) is a mechanism providing mutual exclusion<ul>
<li>Mutex ensures that only one thread has access to a critical section</li>
<li>Using operations like a lock and unlock</li>
<li>Used to protect the critical sections</li>
</ul>
</li>
</ul>

        <h2 id="Peterson’s-Solution"   >
          <a href="#Peterson’s-Solution" class="heading-link"><i class="fas fa-link"></i></a><a href="#Peterson’s-Solution" class="headerlink" title="Peterson’s Solution"></a>Peterson’s Solution</h2>
      <ul>
<li><p>Two processes running on two cores: index 0 and 1</p>
</li>
<li><p>Assume that the LOAD and STORE instructions are atomic</p>
<ul>
<li>Atomic: non-interruptable</li>
</ul>
</li>
<li><p>The processes share two variable: int turn and Boolean <code>flag[n](n=0 or 1)</code></p>
<ul>
<li>turn indicates whose turn it is to enter CS</li>
<li><code>flag[n]=TRUE</code> implies that process P0 is ready to enter(similar for <code>flag[1]</code>)<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230216172127.png"></li>
</ul>
</li>
<li><p>Mutual exclusive</p>
<ul>
<li>If one process is in CS, the other process cannot enter CS<ul>
<li>Say, P0 is in CS, then <code>flag[0] == TRUE</code></li>
<li>When P1 tests while condition, <code>turn == 0</code>, so P1 is blocked at the while loop until P0 leaves CS and <code>flag[0]== FALSE</code></li>
</ul>
</li>
<li>If both porcesses try to enter the CS<ul>
<li>If both of them enters, it must be <code>flag[0]==flag[1]== TRUE</code></li>
<li>P0 entring CS requires <code>turn==0</code>;P1 enter CS requires <code>turn==1</code><ul>
<li>Both <code>turn==0</code> and <code>turn==1</code>, which is impossible</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Progress</p>
<ul>
<li>If only one process wants to enter CS, it can enter<ul>
<li>when P0 tests the while condition, P1 does not set <code>flag[1] = TRUE</code>, i.e., <code>flag[1]==FALSE</code>, so P0 can enter CS</li>
</ul>
</li>
<li>If both processes want to enter CS, one of them can enter<ul>
<li>If both P0 and P1 have set the <code>flag</code> to be <code>TRUE</code>, then they continue to set <code>turn</code></li>
<li>Eventually, <code>turn</code> is either <code>0</code> or <code>1</code>, and the coresponding process can enter CS</li>
</ul>
</li>
</ul>
</li>
<li><p>Bounded waitting </p>
<ul>
<li>If both want to repeatedly enter CS, they will do so in turn<ul>
<li>When P0 leaves CS, it sets <code>flag[0]==FALSE</code>, so P1 immediately can enter CS</li>
<li>If P0 set <code>flag[0]==TRUE</code> before P1 enters CS, P1 cannot leave the while loop</li>
<li>However, before P0 enters CS again, it has to set <code>turn==1</code>, so P1 still can leave the while loop and enter CS</li>
</ul>
</li>
</ul>
</li>
</ul>

        <h2 id="Hardware-Support-for-Synchronization"   >
          <a href="#Hardware-Support-for-Synchronization" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hardware-Support-for-Synchronization" class="headerlink" title="Hardware Support for Synchronization"></a>Hardware Support for Synchronization</h2>
      <ul>
<li>Many systems porvide hardware spport for critical section code</li>
<li>Uniprocessors - could disable interrupts<ul>
<li>Currently running code would excute without preemption</li>
<li>Generally too inefficient: OS using this not broadly scalable</li>
</ul>
</li>
<li>Modern machines provide special atomic hardware instructions<ul>
<li>Two widely used types:<ul>
<li>Test memory word and set value</li>
<li>Swap contents of two memory words</li>
</ul>
</li>
</ul>
</li>
</ul>

        <h2 id="TestAndSet-Instruction"   >
          <a href="#TestAndSet-Instruction" class="heading-link"><i class="fas fa-link"></i></a><a href="#TestAndSet-Instruction" class="headerlink" title="TestAndSet Instruction"></a>TestAndSet Instruction</h2>
      <p><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230223163014.png"></p>

        <h2 id="Swap-Instruction"   >
          <a href="#Swap-Instruction" class="heading-link"><i class="fas fa-link"></i></a><a href="#Swap-Instruction" class="headerlink" title="Swap Instruction"></a>Swap Instruction</h2>
      <p><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230223163810.png"></p>

        <h2 id="Semaphore"   >
          <a href="#Semaphore" class="heading-link"><i class="fas fa-link"></i></a><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h2>
      <ul>
<li><p>Semaphore S – integer variable</p>
</li>
<li><p>Two standard operations modfy S: wait() and signal()</p>
<ul>
<li>Originally called P() and V()</li>
</ul>
</li>
<li><p>Counting semaphore - S value can be positive integers</p>
<ul>
<li>Multiple copies of the shared resource</li>
</ul>
</li>
<li><p>Binary semaphore - S value can be 0 or 1;</p>
</li>
<li><p>Must guarantee no two processes execute wait() and signal() on the same semaphore at the same time</p>
</li>
<li><p>Thus, implementation becomes the critical section problem where the wait and signal code are placed in the critical section problem</p>
</li>
</ul>

        <h3 id="Semaphore-with-Busy-Waiting"   >
          <a href="#Semaphore-with-Busy-Waiting" class="heading-link"><i class="fas fa-link"></i></a><a href="#Semaphore-with-Busy-Waiting" class="headerlink" title="Semaphore with Busy Waiting"></a>Semaphore with Busy Waiting</h3>
      <ul>
<li>Spinlock<ul>
<li>Implementation is simple</li>
<li>Little busy waiting if critical section rarely occupied</li>
<li>Not a good solution if applications spend lots of time in critical sections</li>
</ul>
</li>
</ul>

        <h3 id="Semaphore-with-No-Busy-Waiting"   >
          <a href="#Semaphore-with-No-Busy-Waiting" class="heading-link"><i class="fas fa-link"></i></a><a href="#Semaphore-with-No-Busy-Waiting" class="headerlink" title="Semaphore with No Busy Waiting"></a>Semaphore with No Busy Waiting</h3>
      <ul>
<li><p>Each semaphore has an associated waiting queue</p>
<ul>
<li>Each entry in a waiting queue has two data items<ul>
<li>value</li>
<li>pointer to next record in the list</li>
</ul>
</li>
</ul>
</li>
<li><p>Two operations:</p>
<ul>
<li>block - place the process invoking the operation in the appropriate waiting queue</li>
<li>wakeup - remove one of processes in the waiting queue and place it in the ready queue</li>
</ul>
</li>
</ul>

        <h2 id="Deadlock"   >
          <a href="#Deadlock" class="heading-link"><i class="fas fa-link"></i></a><a href="#Deadlock" class="headerlink" title="Deadlock"></a>Deadlock</h2>
      <ul>
<li>Deadlock – is a situation in which no process can proceed because each waits for another to release a lock</li>
<li>Let S and Q be two semaphores initialized to 1<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230223171657.png"></li>
</ul>

        <h2 id="Classical-Synchronization-Problems"   >
          <a href="#Classical-Synchronization-Problems" class="heading-link"><i class="fas fa-link"></i></a><a href="#Classical-Synchronization-Problems" class="headerlink" title="Classical Synchronization Problems"></a>Classical Synchronization Problems</h2>
      <ul>
<li>Bounded-Buffer Problem</li>
<li>Readers and Writers Problem</li>
<li>Dining-Philosophers Problem</li>
</ul>

        <h3 id="Bounded-Buffer-Problem"   >
          <a href="#Bounded-Buffer-Problem" class="heading-link"><i class="fas fa-link"></i></a><a href="#Bounded-Buffer-Problem" class="headerlink" title="Bounded-Buffer Problem"></a>Bounded-Buffer Problem</h3>
      <ul>
<li>Multiple producers and consumers share a single buffer of size N<ul>
<li>Producers write data to the buffer; must block if the buffer is full</li>
<li>Consumers read data from the buffer; must block if the buffer is empty</li>
</ul>
</li>
<li>A solution: use three semaphores<ul>
<li>mutex(boolean, initialized to be 1):protect access to the critical sections</li>
<li>full(initialized to be 0): to count the ocuupied slots in the buffer</li>
<li>empty(initialized to be N): to count the available slots in the buffer<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230223172726.png"></li>
</ul>
</li>
</ul>

        <h3 id="Readers-Writers-Problem"   >
          <a href="#Readers-Writers-Problem" class="heading-link"><i class="fas fa-link"></i></a><a href="#Readers-Writers-Problem" class="headerlink" title="Readers-Writers Problem"></a>Readers-Writers Problem</h3>
      <ul>
<li><p>A data set is shared among a number of processes</p>
<ul>
<li>Readers: only read the data set; do not perform any write</li>
<li>Writers: can both read and write</li>
</ul>
</li>
<li><p>Target:</p>
<ul>
<li>Multiple readers can access at the same time.</li>
<li>Only one single writer can access at the same time(no reader access)</li>
</ul>
</li>
<li><p>A solution: two semaphores and a shared variable</p>
<ul>
<li>Two boolean semaphores<ul>
<li>mutex intialized to 1</li>
<li>wrt initialized to 1</li>
</ul>
</li>
<li>Shared integer variable readcount initialized to 0<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230223173215.png"></li>
</ul>
</li>
</ul>

        <h3 id="Dining-Philosophers-Problem"   >
          <a href="#Dining-Philosophers-Problem" class="heading-link"><i class="fas fa-link"></i></a><a href="#Dining-Philosophers-Problem" class="headerlink" title="Dining-Philosophers Problem"></a>Dining-Philosophers Problem</h3>
      <ul>
<li>Five philosophers</li>
<li>Two chopsticks next to each philosopher</li>
<li>A philosopher sometimes thinks, sometimes eats, repeatedly</li>
<li>Need two chipsticks to eat</li>
<li>Hold the chopstick(s) until this time of eating finished<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230223173845.png"></li>
<li>A solution:<ul>
<li>Binary semphores chopstick[5], all initialized to 1<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230223173914.png"></li>
</ul>
</li>
</ul>

        <h2 id="Condition-Variable"   >
          <a href="#Condition-Variable" class="heading-link"><i class="fas fa-link"></i></a><a href="#Condition-Variable" class="headerlink" title="Condition Variable"></a>Condition Variable</h2>
      <ul>
<li>There are mau cases where a thread wishes to check whether a condition is true before continuing its execution</li>
<li>Example:<ul>
<li>A parent thread might wish to check whether a child thread has been completed, before continue to execute<ul>
<li>join<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302152249.png"></li>
</ul>
</li>
</ul>
</li>
</ul>

        <h3 id="Parent-Waiting-for-Child-Spin-based-Approach"   >
          <a href="#Parent-Waiting-for-Child-Spin-based-Approach" class="heading-link"><i class="fas fa-link"></i></a><a href="#Parent-Waiting-for-Child-Spin-based-Approach" class="headerlink" title="Parent Waiting for Child: Spin-based Approach"></a>Parent Waiting for Child: Spin-based Approach</h3>
      <p><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302152346.png"></p>
<ul>
<li><p>Inefficient as the parent spins and wastes CPU time</p>
</li>
<li><p>Can we put the parent to sleep until the condition we are waiting ofr comes true?</p>
</li>
<li><p>Condition variable</p>
<ul>
<li>Waiting on the condition<ul>
<li>An explicit queue that threads can put themselves on when some state of execution is not as desired</li>
</ul>
</li>
<li>Signaling on the condition<ul>
<li>Some other thread, when it changes said state, can wake one of those waiting threads and allow them to continue.</li>
</ul>
</li>
</ul>
</li>
<li><p>Declare condtion variable<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302152851.png"></p>
<ul>
<li>Proper initialization is required</li>
</ul>
</li>
<li><p>Operation (the POSIX calls)<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302153314.png"></p>
<ul>
<li>The wait() call takes a mutex as a parameter<ul>
<li>The wait() call release the lock and put the calling thread to sleep</li>
<li>When the thread wakes up, it must re-acquire the lock</li>
</ul>
</li>
</ul>
</li>
</ul>

        <h3 id="Parent-waiting-for-Child-Using-Condition-Variable"   >
          <a href="#Parent-waiting-for-Child-Using-Condition-Variable" class="heading-link"><i class="fas fa-link"></i></a><a href="#Parent-waiting-for-Child-Using-Condition-Variable" class="headerlink" title="Parent waiting for Child: Using Condition Variable"></a>Parent waiting for Child: Using Condition Variable</h3>
      <p><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302153701.png"></p>

        <h3 id="Importance-of-the-state-variable-done"   >
          <a href="#Importance-of-the-state-variable-done" class="heading-link"><i class="fas fa-link"></i></a><a href="#Importance-of-the-state-variable-done" class="headerlink" title="Importance of the state variable done"></a>Importance of the state variable done</h3>
      <ul>
<li>Imagine the case where the child runs immediately<ul>
<li>The child will signal, but there is no thread asleep on the condtion.</li>
<li>When the parent runs, it will call wait and be stuck</li>
<li>No thread will ever wake it<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302154111.png"></li>
</ul>
</li>
</ul>

        <h3 id="Importance-of-the-mutex"   >
          <a href="#Importance-of-the-mutex" class="heading-link"><i class="fas fa-link"></i></a><a href="#Importance-of-the-mutex" class="headerlink" title="Importance of the mutex"></a>Importance of the mutex</h3>
      <ul>
<li>If one does not need to hold a lock in order to signal and wait</li>
<li>There is <strong>race condition</strong><ul>
<li>The parent calls thr_join()<ul>
<li>The parent checks done, it will see that it is 0 and try to go to sleep</li>
<li>Just before it calls wait to go to sleep, the parent is interrupted and the child runs</li>
</ul>
</li>
<li>The child cahnges the state variable done to 1 and signals</li>
<li>When the parent runs again, it sleeps forever.<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302155321.png"></li>
</ul>
</li>
</ul>

        <h2 id="Producer-Consumer-Problem"   >
          <a href="#Producer-Consumer-Problem" class="heading-link"><i class="fas fa-link"></i></a><a href="#Producer-Consumer-Problem" class="headerlink" title="Producer-Consumer Problem"></a>Producer-Consumer Problem</h2>
      <ul>
<li><p>Suppose the buffer size is 1</p>
</li>
<li><p>Producer</p>
<ul>
<li>Produce data items</li>
<li>Wish to place data items in a buffer</li>
</ul>
</li>
<li><p>Consumer </p>
<ul>
<li>Grab data items out of the buffer and consume them in some way</li>
</ul>
</li>
<li><p><strong>Producer</strong> </p>
<ul>
<li>Produce data items</li>
<li>Wish to place data items in a buffer</li>
</ul>
</li>
<li><p><strong>Consumer</strong></p>
<ul>
<li>Grab data items out of the buffer and consume them in some way</li>
</ul>
</li>
<li><p>Producer puts an integer into the shared buffer and loops</p>
</li>
<li><p>Consummer gets the data out of that shared buffer<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302161653.png"></p>
</li>
</ul>

        <h3 id="The-Put-and-Get-Routines"   >
          <a href="#The-Put-and-Get-Routines" class="heading-link"><i class="fas fa-link"></i></a><a href="#The-Put-and-Get-Routines" class="headerlink" title="The Put and Get Routines"></a>The Put and Get Routines</h3>
      <ul>
<li>Only put data into the buffer when count is zero<ul>
<li>i.e. when the buffer is empty</li>
</ul>
</li>
<li>Only get data from the buffer when count is one<ul>
<li>i.e. when the buffer is full<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302161811.png"></li>
</ul>
</li>
</ul>

        <h3 id="Using-Condition-Variable"   >
          <a href="#Using-Condition-Variable" class="heading-link"><i class="fas fa-link"></i></a><a href="#Using-Condition-Variable" class="headerlink" title="Using Condition Variable"></a>Using Condition Variable</h3>
      <ul>
<li><p>A condition variable cond and associated lock mutex</p>
</li>
<li><p>p1-p3: A producer waits for the buffer to be empty</p>
</li>
<li><p>c1-c3: A consumer waits for the buffer to be full</p>
</li>
<li><p>with just a single producer and a single consumer, the code works<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302162036.png"></p>
</li>
</ul>

        <h4 id="Trace"   >
          <a href="#Trace" class="heading-link"><i class="fas fa-link"></i></a><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h4>
      <p><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302162102.png"></p>

        <h3 id="Why-the-Solution-is-Broken"   >
          <a href="#Why-the-Solution-is-Broken" class="heading-link"><i class="fas fa-link"></i></a><a href="#Why-the-Solution-is-Broken" class="headerlink" title="Why the Solution is Broken?"></a>Why the Solution is Broken?</h3>
      <ul>
<li>The problem arises because:<ul>
<li>After the producer woke, but before ever ran, the state of the bounded buffer changed by</li>
<li>There is no guarantee that when the woken thread runs, the state will still be as desired <strong>Mesa semantics</strong><ul>
<li>Virtually every system ever built employs Mesa semantics</li>
</ul>
</li>
<li><strong>Hoare semantics</strong> provides a stronger guarantee that the woken thread will immdiately upon being woken.</li>
</ul>
</li>
</ul>

        <h3 id="Fix-the-Problem"   >
          <a href="#Fix-the-Problem" class="heading-link"><i class="fas fa-link"></i></a><a href="#Fix-the-Problem" class="headerlink" title="Fix the Problem"></a>Fix the Problem</h3>
      <ul>
<li>Consumer wakes up and re-checks the shared variable<ul>
<li>If the buffer is empty, the consumer simply goes back to sleep.</li>
</ul>
</li>
<li>Is it correct now?<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302163650.png"></li>
</ul>

        <h4 id="Trace-1"   >
          <a href="#Trace-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Trace-1" class="headerlink" title="Trace"></a>Trace</h4>
      <p><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302164138.png"></p>
<p><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302164204.png"></p>

        <h3 id="Fix-the-Problem-1"   >
          <a href="#Fix-the-Problem-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Fix-the-Problem-1" class="headerlink" title="Fix the Problem"></a>Fix the Problem</h3>
      <ul>
<li>Using two condtion variable and while<ul>
<li><strong>Producer</strong> threads wait on the condition empty, and signal fill</li>
<li><strong>Consumer</strong> threads wait on fill and signal empty<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302164546.png"></li>
</ul>
</li>
</ul>

        <h4 id="Multiple-Buffer-Slots"   >
          <a href="#Multiple-Buffer-Slots" class="heading-link"><i class="fas fa-link"></i></a><a href="#Multiple-Buffer-Slots" class="headerlink" title="Multiple Buffer Slots"></a>Multiple Buffer Slots</h4>
      <ul>
<li>More concurrency and efficiency <strong>&#x3D;&gt;</strong> Add more buffer slots</li>
<li>Reduce context switches<br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302164727.png"><br><img src="https://raw.githubusercontent.com/LemonKAI/image/main/20230302164819.png"></li>
</ul>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文結束，感謝您的閱讀 ------</div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://lemonkai.github.io/tags/CS3103/">CS3103</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://lemonkai.github.io/tags/Operating-System/">Operating System</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2023/02/27/CS3481-Lecture-5/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">CS3481-Lecture-5</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2023/02/13/CS3481-Lecture-4/"><span class="paginator-prev__text">CS3481-Lecture-4-Classifier Evaluation</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="utterances-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目錄</span><span class="sidebar-nav-ov">本站概覽</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Synchronization"><span class="toc-number">1.</span> <span class="toc-text">
          Synchronization</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Backgrouond"><span class="toc-number">1.1.</span> <span class="toc-text">
          Backgrouond</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Race-Condition"><span class="toc-number">1.2.</span> <span class="toc-text">
          Race Condition</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Critical-Section"><span class="toc-number">1.3.</span> <span class="toc-text">
          Critical Section</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mutex-Lock"><span class="toc-number">1.4.</span> <span class="toc-text">
          Mutex Lock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Peterson%E2%80%99s-Solution"><span class="toc-number">1.5.</span> <span class="toc-text">
          Peterson’s Solution</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hardware-Support-for-Synchronization"><span class="toc-number">1.6.</span> <span class="toc-text">
          Hardware Support for Synchronization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TestAndSet-Instruction"><span class="toc-number">1.7.</span> <span class="toc-text">
          TestAndSet Instruction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Swap-Instruction"><span class="toc-number">1.8.</span> <span class="toc-text">
          Swap Instruction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Semaphore"><span class="toc-number">1.9.</span> <span class="toc-text">
          Semaphore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Semaphore-with-Busy-Waiting"><span class="toc-number">1.9.1.</span> <span class="toc-text">
          Semaphore with Busy Waiting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Semaphore-with-No-Busy-Waiting"><span class="toc-number">1.9.2.</span> <span class="toc-text">
          Semaphore with No Busy Waiting</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deadlock"><span class="toc-number">1.10.</span> <span class="toc-text">
          Deadlock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Classical-Synchronization-Problems"><span class="toc-number">1.11.</span> <span class="toc-text">
          Classical Synchronization Problems</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bounded-Buffer-Problem"><span class="toc-number">1.11.1.</span> <span class="toc-text">
          Bounded-Buffer Problem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Readers-Writers-Problem"><span class="toc-number">1.11.2.</span> <span class="toc-text">
          Readers-Writers Problem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dining-Philosophers-Problem"><span class="toc-number">1.11.3.</span> <span class="toc-text">
          Dining-Philosophers Problem</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Condition-Variable"><span class="toc-number">1.12.</span> <span class="toc-text">
          Condition Variable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Parent-Waiting-for-Child-Spin-based-Approach"><span class="toc-number">1.12.1.</span> <span class="toc-text">
          Parent Waiting for Child: Spin-based Approach</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Parent-waiting-for-Child-Using-Condition-Variable"><span class="toc-number">1.12.2.</span> <span class="toc-text">
          Parent waiting for Child: Using Condition Variable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Importance-of-the-state-variable-done"><span class="toc-number">1.12.3.</span> <span class="toc-text">
          Importance of the state variable done</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Importance-of-the-mutex"><span class="toc-number">1.12.4.</span> <span class="toc-text">
          Importance of the mutex</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Producer-Consumer-Problem"><span class="toc-number">1.13.</span> <span class="toc-text">
          Producer-Consumer Problem</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Put-and-Get-Routines"><span class="toc-number">1.13.1.</span> <span class="toc-text">
          The Put and Get Routines</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-Condition-Variable"><span class="toc-number">1.13.2.</span> <span class="toc-text">
          Using Condition Variable</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Trace"><span class="toc-number">1.13.2.1.</span> <span class="toc-text">
          Trace</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-the-Solution-is-Broken"><span class="toc-number">1.13.3.</span> <span class="toc-text">
          Why the Solution is Broken?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fix-the-Problem"><span class="toc-number">1.13.4.</span> <span class="toc-text">
          Fix the Problem</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Trace-1"><span class="toc-number">1.13.4.1.</span> <span class="toc-text">
          Trace</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fix-the-Problem-1"><span class="toc-number">1.13.5.</span> <span class="toc-text">
          Fix the Problem</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Multiple-Buffer-Slots"><span class="toc-number">1.13.5.1.</span> <span class="toc-text">
          Multiple Buffer Slots</span></a></li></ol></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">Seize the Day</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">14</div><div class="sidebar-ov-state-item__name">歸檔</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">7</div><div class="sidebar-ov-state-item__name">分類</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">8</div><div class="sidebar-ov-state-item__name">標籤</div></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已閱讀了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>KAI</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function loadUtterances() {
  var d = document, s = d.createElement('script');
  var container = d.getElementById('utterances-container');

  if (!container) {
    return;
  }
  s.src = 'https://utteranc.es/client.js';
  s.setAttribute('repo', 'LemonKAI/KAIBlogComment');
  s.setAttribute('issue-term', 'title');
  s.setAttribute('label', 'utterances');
  s.setAttribute('theme', 'github-light');
  s.setAttribute('crossorigin', 'anonymous');
  s.setAttribute('async', '');
  if (false) {
    s.setAttribute('data-pjax-rm', '');
  }
  container.append(s);
}

if (false) {
  loadUtterances();
} else {
  window.addEventListener('DOMContentLoaded', loadUtterances, false);
}</script><script src="/js/utils.js?v=2.8.0"></script><script src="/js/stun-boot.js?v=2.8.0"></script><script src="/js/scroll.js?v=2.8.0"></script><script src="/js/header.js?v=2.8.0"></script><script src="/js/sidebar.js?v=2.8.0"></script></body></html>